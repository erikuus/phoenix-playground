<p>
  The <code>Sort</code> module demonstrates handle-event sorting using
  LiveView's <code>handle_event</code> mechanism rather than URL parameters.
  This approach maintains sort state in the socket assigns, providing instant
  sorting feedback without page navigation while keeping the URL clean and
  unchanged.
</p>

<h3><code>mount/3</code></h3>
<ul>
  <li>
    Initializes the LiveView with default sorting options (<code
      >sort_order: :asc</code
    >
    and <code>sort_by: :name</code>), ensuring the table displays sorted data
    immediately when the page loads.
  </li>
  <li>
    Calls <code>apply_sorting_options/2</code> to load the initial city data
    with the default sort applied, storing both the sorted cities and the sort
    options in socket assigns.
  </li>
</ul>

<h3><code>apply_sorting_options/2</code></h3>
<ul>
  <li>
    Updates the socket with sorted city data from
    <code>Cities.list_country_city/3</code> and stores the current sorting
    options in socket assigns for the template to determine sort indicator and
    next sort order of clickable sort links in table header.
  </li>
</ul>

<h3><code>render/1</code></h3>
<ul>
  <li>
    Creates a table where each column header is generated by
    <code>sort_link/3</code>, which creates clickable links that include visual
    sort indicators and the proper event parameters for sorting.
  </li>
</ul>

<h3><code>sort_link/3</code></h3>
<ul>
  <li>
    Generates a clickable link for each table column header that includes the
    column name, visual sort indicator, and the next sort action to perform when
    clicked.
  </li>
  <li>
    Uses <code>get_next_sort_order/2</code> to determine what sort order should
    be applied when this column is clicked: toggles between
    <code>:asc</code> and <code>:desc</code> for the currently sorted column, or
    defaults to <code>:asc</code> for other columns.
  </li>
  <li>
    Includes <code>phx-value-order</code> and
    <code>phx-value-by</code> attributes that become the event payload when the
    link is clicked, allowing <code>handle_event/3</code>
    to receive next sort parameters.
  </li>
  <li>
    Displays a visual indicator (↑ or ↓) next to the currently sorted column
    using
    <code>get_indicator/2</code> to show users the current sort direction.
  </li>
</ul>

<h3><code>handle_event/3</code> for <code>"sort"</code></h3>
<ul>
  <li>
    When a user clicks on a sort link, this function is triggered. It constructs
    the new sorting options based on the user's choice and updates the state
    with the <code>apply_sorting_options/2</code> function.
  </li>
</ul>

<h3>Helper Functions</h3>
<h4>Sort Logic</h4>
<ul>
  <li>
    <code>get_indicator/2</code> returns a visual arrow (↑ for ascending, ↓ for
    descending) for the currently sorted column, or an empty string for inactive
    columns.
  </li>
  <li>
    <code>get_next_sort_order/2</code> determines the sort order for the next
    click: toggles between <code>:asc</code> and <code>:desc</code> for the
    currently sorted column, or returns <code>:asc</code> for inactive columns.
  </li>
</ul>

<h4>Security</h4>
<ul>
  <li>
    <code>to_permitted_atom/3</code> safely converts string parameters to atoms
    by checking against predefined whitelists (<code
      >@permitted_sort_orders</code
    >
    and <code>@permitted_sort_by</code>).
  </li>
</ul>

<h3>Security: Safe Parameter Conversion</h3>
<p>
  This module demonstrates an essential security pattern for LiveView
  applications that convert user input to atoms. The
  <code>to_permitted_atom/3</code> function prevents atom exhaustion attacks by
  validating input against predefined whitelists.
</p>

<h4>The Problem</h4>
<p>
  Creating atoms from user input with <code>String.to_atom/1</code> is dangerous
  because atoms are never garbage collected. Malicious users could exhaust
  system memory by sending many unique strings, each creating a permanent atom.
</p>

<h4>The Solution</h4>
<p>The function uses a three-layer validation approach:</p>
<ul>
  <li>
    <strong>Type and size check:</strong> Ensures input is a string with
    reasonable length to prevent processing malicious payloads that could
    consume excessive memory or CPU during validation.
  </li>
  <li>
    <strong>Whitelist check:</strong> Validates against predefined allowed
    values because we only want to accept "asc", "desc", "name", "district", and
    "population" - any other input should be rejected with a safe fallback
    value.
  </li>
  <li>
    <strong>Safe conversion:</strong> Uses
    <code>String.to_existing_atom/1</code>
    as a defensive programming practice to ensure no new atoms are created,
    providing an additional safety layer in case of future code changes or bugs
    in the whitelist logic.
  </li>
</ul>
