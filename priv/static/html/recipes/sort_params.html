<p>
  The <code>SortParams</code> module demonstrates URL parameter-based sorting
  that maintains sort state in the browser's address bar. Unlike event-based
  sorting (see the <code>Sort</code> module), this approach makes sort states
  bookmarkable, shareable, and persistent across browser refreshes and
  navigation.
</p>

<h3><code>mount/3</code></h3>
<p>
  The mount function sets up the LiveView without preset sorting parameters. The
  actual sorting options are determined by the URL parameters and set in the
  <code>handle_params/3</code> function.
</p>

<h3><code>handle_params/3</code></h3>
<p>
  This function is LiveView's entry point for URL-driven state management. Every
  time the URL changes (initial page load, browser navigation, or
  <code>push_patch</code> updates), Phoenix calls this function with the current
  query parameters.
</p>
<ul>
  <li>
    <strong>First clause:</strong> Handles URLs with both
    <code>sort_order</code> and <code>sort_by</code> parameters (like
    <code>/sort-params?sort_by=population&sort_order=desc</code>)
  </li>
  <li>
    <strong>Second clause:</strong> Handles all other cases—missing parameters,
    partial parameters, or initial page loads without query strings
  </li>
  <li>
    <strong>Parameter validation:</strong> Uses
    <code>to_permitted_atom/3</code> to safely convert string parameters to
    atoms while protecting against invalid values
  </li>
  <li>
    <strong>Fallback behavior:</strong> When parameters are missing or invalid,
    defaults to ascending name sorting (<code>@default_sort_options</code>)
  </li>
</ul>

<h4>Helpers for <code>handle_params/3</code></h4>
<ul>
  <li>
    <code>to_permitted_atom/3</code> - Safely converts URL parameters from
    strings to atoms by validating against predefined whitelists (<code
      >@permitted_sort_orders</code
    >
    and <code>@permitted_sort_by</code>). This prevents atom exhaustion attacks
    while ensuring only valid sort options are processed.
  </li>
  <li>
    <code>apply_sorting_options/2</code> - Updates the socket with sorted city
    data and stores the current sorting options for the template to use when
    rendering sort links and indicators.
  </li>
</ul>

<h3><code>render/1</code></h3>
<p>
  The render function generates the HTML for the page, creating a table with
  data rows based on the city information available in the assigns. The
  <code>sort_link/2</code> function is invoked for each column header, providing
  interactive sorting links.
</p>

<h3><code>sort_link/3</code></h3>
<ul>
  <li>
    Generates a clickable link for each table column header that includes the
    column name, visual sort indicator, and the next sort action to perform when
    clicked.
  </li>
  <li>
    Uses <code>get_next_sort_order/2</code> to determine what sort order should
    be applied when this column is clicked: toggles between
    <code>:asc</code> and <code>:desc</code> for the currently sorted column, or
    defaults to <code>:asc</code> for other columns.
  </li>
  <li>
    Creates a URL with
    <code>~p"/sort-params?#{[sort_by: col, sort_order: ...]}"</code> that
    includes the new sort parameters, allowing users to bookmark or share
    specific sort states.
  </li>
  <li>
    Uses <code>.link</code> with <code>patch={@to}</code> to update the URL
    without a full page reload, triggering <code>handle_params/3</code> to
    process the new sort parameters.
  </li>
  <li>
    Displays a visual indicator (↑ or ↓) next to the currently sorted column
    using <code>get_indicator/2</code> to show users the current sort direction.
  </li>
</ul>

<h3>Helper Functions</h3>
<ul>
  <li>
    <strong><code>get_indicator/2</code></strong
    >: Returns a visual arrow (↑ for ascending, ↓ for descending) for the
    currently sorted column, or an empty string for inactive columns.
  </li>
  <li>
    <strong><code>get_next_sort_order/2</code></strong
    >: Determines the sort order for the next click: toggles between
    <code>:asc</code> and <code>:desc</code> for the currently sorted column, or
    returns <code>:asc</code> for inactive columns.
  </li>
</ul>

<h3>URL Parameter vs Event-Based Sorting</h3>
<p>
  This module demonstrates a fundamentally different approach from the
  <code>Sort</code> module:
</p>

<h4>URL Parameter Approach (This Module)</h4>
<ul>
  <li>
    <strong>State location:</strong> Sort options stored in URL query parameters
  </li>
  <li>
    <strong>User interaction:</strong> Clicking sort links updates the URL via
    <code>push_patch</code>
  </li>
  <li>
    <strong>Benefits:</strong> Bookmarkable, shareable, browser-navigation
    friendly
  </li>
</ul>
<h4>Event-Based Approach (Sort Module)</h4>
<ul>
  <li>
    <strong>State location:</strong> Sort options stored in socket assigns
  </li>
  <li>
    <strong>User interaction:</strong> Clicking sort links triggers
    <code>handle_event/3</code>
  </li>
  <li>
    <strong>Benefits:</strong> Faster response, cleaner URLs, simpler state
    management
  </li>
</ul>
<h4>The Parameter Flow</h4>
<ol>
  <li>User clicks sort link → URL updates via <code>push_patch</code></li>
  <li>URL change triggers <code>handle_params/3</code> with new parameters</li>
  <li>
    <code>handle_params/3</code> validates parameters and updates socket state
  </li>
  <li>Template re-renders with newly sorted data</li>
</ol>

<h3>Security: Safe Parameter Conversion</h3>
<p>
  This module demonstrates an essential security pattern for LiveView
  applications that convert user input to atoms. The
  <code>to_permitted_atom/3</code> function prevents atom exhaustion attacks by
  validating input against predefined whitelists.
</p>
<h4>The Problem</h4>
<p>
  Creating atoms from user input with <code>String.to_atom/1</code> is dangerous
  because atoms are never garbage collected. Malicious users could exhaust
  system memory by sending many unique strings, each creating a permanent atom.
</p>
<h4>The Solution</h4>
<p>The function uses a three-layer validation approach:</p>
<ul>
  <li>
    <strong>Type and size check:</strong> Ensures input is a string with
    reasonable length to prevent processing malicious payloads that could
    consume excessive memory or CPU during validation.
  </li>
  <li>
    <strong>Whitelist check:</strong> Validates against predefined allowed
    values because we only want to accept "asc", "desc", "name", "district", and
    "population" - any other input should be rejected with a safe fallback
    value.
  </li>
  <li>
    <strong>Safe conversion:</strong> Uses
    <code>String.to_existing_atom/1</code>
    as a defensive programming practice to ensure no new atoms are created,
    providing an additional safety layer in case of future code changes or bugs
    in the whitelist logic.
  </li>
</ul>
